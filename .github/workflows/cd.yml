name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_dashboard:
        description: 'Deploy dashboard'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.9'

jobs:
  train-and-validate:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -e .[dashboard]
      
      - name: Create directories
        run: |
          mkdir -p data/raw data/processed
          mkdir -p artifacts/{models,metrics,predictions,logs,exports}
          mkdir -p artifacts/exports/par_ville
      
      - name: Generate training data
        run: |
          python scripts/generate_data.py --samples 2000 --output data/raw/washington_real_estate.csv
      
      - name: Train quantile models
        run: |
          python -c "
          from src.models.quantile_trainer import QuantileTrainer
          trainer = QuantileTrainer()
          trainer.run_training_pipeline('data/raw/washington_real_estate.csv')
          print('âœ… Quantile models trained successfully')
          "
      
      - name: Generate predictions
        run: |
          python -c "
          from src.models.predict import PredictionPipeline
          pipeline = PredictionPipeline()
          results = pipeline.run_prediction_pipeline('data/raw/washington_real_estate.csv', has_target=True)
          print('âœ… Predictions generated successfully')
          "
      
      - name: Evaluate predictions
        run: |
          python -c "
          from src.evaluation.metrics import ModelEvaluator
          import pandas as pd
          
          preds = pd.read_csv('artifacts/predictions/predictions_complete_*.csv')
          metrics = ModelEvaluator.calculate_all_metrics(
              preds['sale_price'], 
              preds['predicted_price']
          )
          print(f'Model Performance: {metrics}')
          "
      
      - name: Export predictions by city
        run: |
          python scripts/export_predictions.py
      
      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts-${{ github.sha }}
          path: |
            artifacts/models/
            artifacts/metrics/
            artifacts/predictions/
            artifacts/exports/
            data/processed/
          retention-days: 30
          compression-level: 6
      
      - name: Create release archive
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          tar -czf model-artifacts.tar.gz artifacts/models/
      
      - name: Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            model-artifacts.tar.gz
            artifacts/metrics/metrics_*.csv
          generate_release_notes: true

  deploy-dashboard:
    runs-on: ubuntu-latest
    needs: train-and-validate
    if: github.event_name == 'push' || github.event.inputs.deploy_dashboard == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e .[dashboard]
      
      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts-${{ github.sha }}
          path: artifacts/
      
      - name: Test dashboard
        run: |
          python -c "
          import streamlit as st
          print('âœ… Dashboard dependencies installed')
          "
      
      - name: Deploy to Streamlit Cloud (simulated)
        run: |
          echo "ðŸš€ Deploying dashboard..."
          echo "Dashboard URL: https://share.streamlit.io/yourusername/house-price-pi"
          echo "âœ… Deployment successful"

  docker:
    runs-on: ubuntu-latest
    needs: train-and-validate
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,format=long
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max